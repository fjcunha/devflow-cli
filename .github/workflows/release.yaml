name: Release

on:
  push:
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      tag_name:
        description: Tag to release (e.g., v1.2.45)
        required: true

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag_name || github.ref_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.TAG_NAME }}

      - name: Validate tag format
        run: |
          if [[ -z "${TAG_NAME}" ]]; then
            echo "Error: TAG_NAME is not set." >&2
            exit 1
          fi
          if [[ ! "${TAG_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Tag '${TAG_NAME}' must be semver and start with 'v' (e.g., v1.2.45)." >&2
            exit 1
          fi

      - name: Ensure tag matches package major/minor
        env:
          TAG_NAME: ${{ env.TAG_NAME }}
        run: |
          PKG_MAJOR_MINOR=$(node - <<'NODE'
          const { version } = require('./package.json');
          const [major, minor] = String(version).split('.');

          if (major === undefined || minor === undefined) {
            console.error(`Invalid package version '${version}'. Expected at least major.minor.`);
            process.exit(1);
          }

          const parsedMajor = parseInt(major, 10);
          const parsedMinor = parseInt(minor, 10);

          if (Number.isNaN(parsedMajor) || Number.isNaN(parsedMinor)) {
            console.error(`Package major/minor must be numeric (found '${version}').`);
            process.exit(1);
          }

          console.log(`${parsedMajor}.${parsedMinor}`);
          NODE
          )

          TAG_WITHOUT_PREFIX="${TAG_NAME#v}"
          TAG_MAJOR_MINOR="${TAG_WITHOUT_PREFIX%.*}"

          if [[ "${TAG_MAJOR_MINOR}" != "${PKG_MAJOR_MINOR}" ]]; then
            echo "Tag '${TAG_NAME}' does not align with package.json major.minor '${PKG_MAJOR_MINOR}'." >&2
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          registry-url: https://npm.pkg.github.com

      - name: Install dependencies
        run: npm ci --no-fund --no-audit --progress=false

      - name: Run checks
        run: npm run check

      - name: Build
        run: npm run build

      - name: Verify build outputs
        run: |
          test -f dist/cli.js
          test -s dist/cli.js

      - name: Set release version from tag
        id: version
        run: |
          RELEASE_VERSION="${TAG_NAME#v}"
          echo "release_version=${RELEASE_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Update package.json for release
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.release_version }}
          REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));

          // Use tag-driven version and ensure publishable metadata
          pkg.version = process.env.RELEASE_VERSION;
          pkg.publishConfig = { registry: 'https://npm.pkg.github.com' };

          // Add owner prefix to package name if not already present
          const owner = process.env.REPOSITORY_OWNER;
          if (owner && !pkg.name.startsWith(`@${owner}/`)) {
            const bareName = pkg.name.replace(/^@[^/]+\//, '');
            pkg.name = `@${owner}/${bareName}`;
          }

          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          NODE

      - name: Publish to GitHub Packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm publish --access=restricted
